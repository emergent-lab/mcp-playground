# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is an MCP (Model Context Protocol) Playground built with Next.js 16 (App Router), featuring OAuth-based server connections, request logging, and multi-provider authentication. The app allows users to connect to MCP servers, manage OAuth flows, and track API requests.

## Package Manager

This project uses `pnpm` (v10.11.0+). Always use `pnpm` commands, not `npm` or `yarn`.

## Common Commands

### Development
- `pnpm dev:all` - Start PostgreSQL container and Next.js dev server
- `pnpm dev` - Start Next.js dev server only (requires DB running)
- `pnpm build` - Build production bundle
- `pnpm start` - Run production server

### Code Quality
- `pnpm lint` - Run Ultracite linter (check mode)
- `pnpm lint:fix` - Run Ultracite linter (fix mode)
- `pnpm format` - Format code with Biome
- `pnpm typecheck` - Run TypeScript type checking

### Database Management
- `pnpm docker:db:up` - Start PostgreSQL container
- `pnpm docker:db:stop` - Stop PostgreSQL container
- `pnpm docker:db:down` - Stop and remove PostgreSQL container
- `pnpm docker:db:clean` - Stop, remove container and delete volumes
- `pnpm db:generate` - Generate Drizzle migrations from schema
- `pnpm db:migrate` - Run Drizzle migrations
- `pnpm db:push` - Push schema changes directly to database
- `pnpm db:studio` - Open Drizzle Studio GUI

### Authentication
- `pnpm auth:generate` - Generate Better Auth schema (outputs to src/db/schema/auth.ts)

### Email Development
- `pnpm email:dev` - Start React Email dev server on port 3333
- `pnpm email:test` - Test magic link email sending

## Architecture

### Tech Stack
- **Framework**: Next.js 16 (App Router) with React 19
- **Database**: PostgreSQL with Drizzle ORM
- **Authentication**: Better Auth (multi-provider: GitHub OAuth, Magic Link, Anonymous)
- **Email**: React Email with Resend
- **Styling**: Tailwind CSS 4 with class-variance-authority
- **Linting**: Ultracite (AI-ready linter) + Biome

### Directory Structure

```
src/
├── app/                      # Next.js App Router
│   ├── api/auth/[...all]/   # Better Auth catch-all route
│   ├── layout.tsx           # Root layout
│   └── page.tsx             # Home page
├── db/
│   ├── schema/
│   │   ├── auth.ts          # Better Auth schema (auto-generated)
│   │   └── app.ts           # Application schema (server, log tables)
│   └── index.ts             # Drizzle client with combined schema
├── lib/
│   ├── auth.ts              # Better Auth server config
│   ├── auth-client.ts       # Better Auth client hooks
│   ├── email/resend.ts      # Resend client
│   └── utils.ts             # Utility functions
└── env.ts                   # Type-safe environment variables (T3 Env)

emails/                       # React Email templates
migrations/                   # Drizzle migrations
```

### Database Schema

**Combined Schema Pattern**: Auth and app schemas are combined in `src/db/index.ts`

**Auth Tables** (auto-generated by Better Auth):
- `user` - User accounts
- `session` - Active sessions
- `account` - Linked social accounts
- `verification` - Email verification tokens

**App Tables** (`src/db/schema/app.ts`):
- `server` - MCP server connections with OAuth data
  - Stores persistent OAuth client info and tokens
  - Tracks temporary OAuth flow state (verifier, state, auth URL)
  - Links to users via `userId`
  - Unique constraint: one user cannot have duplicate `serverId`
- `log` - Request/response logs for MCP servers
  - Stores HTTP metadata (method, URL, status, duration)
  - Captures request/response headers and bodies
  - Links to both `server` and `user` for efficient querying

### Authentication Flow

**Better Auth Configuration** (`src/lib/auth.ts`):
- Uses Drizzle adapter with PostgreSQL
- Session cookie cache enabled (5 min max age)
- Three auth methods:
  1. **GitHub OAuth** - Social login
  2. **Magic Link** - Passwordless email authentication
  3. **Anonymous** - Guest sessions

**Client Integration** (`src/lib/auth-client.ts`):
- React hooks via `better-auth/react`
- Magic link plugin enabled for client-side flows

**API Route**: `src/app/api/auth/[...all]/route.ts` handles all auth endpoints

### Environment Variables

Managed by T3 Env (`src/env.ts`) with Zod validation:
- `DATABASE_URL` - PostgreSQL connection string
- `GITHUB_CLIENT_ID` - GitHub OAuth app ID
- `GITHUB_CLIENT_SECRET` - GitHub OAuth secret
- `RESEND_API_KEY` - Resend email service key

Set `SKIP_ENV_VALIDATION=true` to bypass validation (useful for codegen).

### MCP Integration

This app integrates with the Model Context Protocol SDK (`@modelcontextprotocol/sdk`). The `server` table stores OAuth credentials and tokens for connecting to MCP servers, while the `log` table tracks all MCP JSON-RPC requests/responses.

### Docker Database

PostgreSQL 17 container configured in `docker-compose.db.yml`:
- Container: `mcp-playground-db`
- Port: 5432
- Default credentials: `postgres`/`postgres`
- Database: `mcp-playground`
- Persistent volume: `postgres-data`

## Development Workflow

1. **First-time setup**:
   ```bash
   pnpm install
   pnpm docker:db:up
   pnpm db:push  # or db:migrate
   ```

2. **Daily development**:
   ```bash
   pnpm dev:all  # Starts DB + dev server
   ```

3. **Schema changes**:
   - Modify `src/db/schema/app.ts` (never edit `auth.ts` directly)
   - Run `pnpm db:generate` to create migration
   - Run `pnpm db:migrate` to apply migration
   - Or use `pnpm db:push` for rapid prototyping (skips migrations)

4. **Better Auth schema updates**:
   - Run `pnpm auth:generate` after updating auth config
   - This regenerates `src/db/schema/auth.ts`

## Important Notes

- **No tRPC**: Despite dependencies, tRPC is not currently set up. API calls use Better Auth routes.
- **React 19 + Compiler**: This project uses React 19 with the React Compiler (babel plugin).
- **Ultracite Rules**: Strict linting rules are enforced via `.cursor/rules/ultracite.mdc`. Follow these patterns.
- **No `console` statements**: Ultracite disallows `console` - use proper logging if needed.
- **Type safety**: Always use `T[]` vs `Array<T>`, `export type` for types, no `any` types.
- **Database adapter**: Better Auth requires Drizzle schema regeneration if auth config changes significantly.
