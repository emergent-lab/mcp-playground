# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is an MCP (Model Context Protocol) Playground built with Next.js 16 (App Router), featuring OAuth-based server connections, request logging, and multi-provider authentication. The app allows users to connect to MCP servers, manage OAuth flows, and track API requests.

## Package Manager

This project uses `pnpm` (v10.11.0+). Always use `pnpm` commands, not `npm` or `yarn`.

## Common Commands

### Development
- `pnpm dev:all` - Start PostgreSQL container and Next.js dev server
- `pnpm dev` - Start Next.js dev server only (requires DB running)
- `pnpm build` - Build production bundle
- `pnpm start` - Run production server

### Code Quality
- `pnpm lint` - Run Ultracite linter (check mode)
- `pnpm lint:fix` - Run Ultracite linter (fix mode)
- `pnpm format` - Format code with Biome
- `pnpm typecheck` - Run TypeScript type checking

### Database Management
- `pnpm docker:db:up` - Start PostgreSQL container
- `pnpm docker:db:stop` - Stop PostgreSQL container
- `pnpm docker:db:down` - Stop and remove PostgreSQL container
- `pnpm docker:db:clean` - Stop, remove container and delete volumes
- `pnpm db:generate` - Generate Drizzle migrations from schema
- `pnpm db:migrate` - Run Drizzle migrations
- `pnpm db:push` - Push schema changes directly to database
- `pnpm db:studio` - Open Drizzle Studio GUI

### Authentication
- `pnpm auth:generate` - Generate Better Auth schema (outputs to src/db/schema/auth.ts)

### Email Development
- `pnpm email:dev` - Start React Email dev server on port 3333
- `pnpm email:test` - Test magic link email sending

## Architecture

### Tech Stack
- **Framework**: Next.js 16 (App Router) with React 19
- **API Layer**: tRPC with React Query (type-safe, auto-completion, prefetching)
- **State Management**: React Query for server state, React hooks for client state
- **Database**: PostgreSQL with Drizzle ORM
- **Authentication**: Better Auth (multi-provider: GitHub OAuth, Magic Link, Anonymous)
- **Email**: React Email with Resend
- **Styling**: Tailwind CSS 4 with class-variance-authority
- **Linting**: Ultracite (AI-ready linter) + Biome

### Directory Structure

```
src/
├── app/                          # Next.js App Router
│   ├── api/auth/[...all]/       # Better Auth catch-all route
│   ├── server/[serverId]/       # Server detail page with prefetching
│   ├── oauth/callback/          # OAuth callback handler
│   ├── layout.tsx               # Root layout with auth providers
│   └── page.tsx                 # Home page
├── components/
│   ├── playground/              # Playground feature (folder-based)
│   │   ├── index.tsx           # Main component
│   │   ├── tools-list.tsx      # Tools list component
│   │   ├── resources-list.tsx  # Resources list component
│   │   ├── prompts-list.tsx    # Prompts list component
│   │   └── utils.ts            # Shared utilities
│   ├── request-logs/           # Request logs feature (folder-based)
│   ├── ui/                     # Reusable UI components
│   └── ...                     # Other components
├── hooks/
│   ├── use-server-capabilities.ts        # Server capabilities query hook
│   ├── use-infinite-query-with-auth.ts   # Auto OAuth redirect hook
│   └── ...
├── server/
│   ├── api/
│   │   ├── routers/
│   │   │   ├── server.ts       # Server endpoints (connect, list tools, etc)
│   │   │   └── logs.ts         # Logs endpoints
│   │   └── trpc.ts             # tRPC configuration
│   ├── services/               # Business logic services
│   └── storage/                # Database access layer
├── lib/
│   ├── trpc/
│   │   ├── client.tsx          # tRPC React Query client
│   │   └── server.tsx          # tRPC server utils & prefetching
│   ├── auth.ts                 # Better Auth server config
│   ├── auth-client.ts          # Better Auth client hooks
│   └── utils.ts                # Utility functions
├── db/
│   ├── schema/
│   │   ├── auth.ts             # Better Auth schema (auto-generated)
│   │   └── app.ts              # Application schema (server, log tables)
│   └── index.ts                # Drizzle client with combined schema
└── env.ts                       # Type-safe environment variables (T3 Env)

emails/                          # React Email templates
migrations/                      # Drizzle migrations
```

### Database Schema

**Combined Schema Pattern**: Auth and app schemas are combined in `src/db/index.ts`

**Auth Tables** (auto-generated by Better Auth):
- `user` - User accounts
- `session` - Active sessions
- `account` - Linked social accounts
- `verification` - Email verification tokens

**App Tables** (`src/db/schema/app.ts`):
- `server` - MCP server connections with OAuth data
  - Stores persistent OAuth client info and tokens
  - Tracks temporary OAuth flow state (verifier, state, auth URL)
  - Links to users via `userId`
  - Unique constraint: one user cannot have duplicate `serverId`
- `log` - Request/response logs for MCP servers
  - Stores HTTP metadata (method, URL, status, duration)
  - Captures request/response headers and bodies
  - Links to both `server` and `user` for efficient querying

### tRPC & React Query Patterns

**Server-Side Prefetching** (`src/app/server/[serverId]/page.tsx`):
- Use `getQueryClient()` to get per-request query client
- Prefetch queries with `void queryClient.prefetchQuery()` (don't await for streaming)
- Wrap with `<HydrateClient>` to stream data to client
- Example: Server details prefetched before page renders

**Client-Side Queries**:
- Use `useQuery` for single queries
- Use `useInfiniteQuery` for paginated data (tools, resources, prompts)
- Access via `api` object from `useTRPC()` hook
- Queries are type-safe with auto-completion

**Mutations**:
- Use `useMutation` for write operations
- Invalidate queries in `onSuccess` callback
- Show loading states with `isPending`
- Display errors with toast notifications

**Cache Invalidation**:
- Specific: `queryClient.invalidateQueries({ queryKey: api.server.list.queryKey() })`
- All queries: `queryClient.invalidateQueries()` (use for destructive operations)
- Invalidate on mutations that affect multiple query types

### Error Handling Patterns

**TRPCError Structure**:
- Use `cause` field for structured error data (not JSON in message)
- Example: `throw new TRPCError({ code: "UNAUTHORIZED", message: "...", cause: { authUrl } })`
- Client can access typed cause data

**JSON-RPC Error Codes** (MCP Protocol):
- `-32601` (Method not found) = Server doesn't support capability
- Treat as "no data" rather than error (no toast, no error UI)
- Helper: `isMethodNotFoundError(error)` checks for -32601

**Auto OAuth Redirect** (`src/hooks/use-infinite-query-with-auth.ts`):
- Wraps `useInfiniteQuery` with automatic error handling
- UNAUTHORIZED errors trigger automatic OAuth redirect
- Method not found errors ignored (server capability check)
- Other errors show toast with retry action

**Error Handling Flow**:
1. Auth errors (UNAUTHORIZED) → Auto redirect to OAuth URL
2. Method not found (-32601) → Treat as "no capability", show empty state
3. Other errors → Toast notification with retry button

### Component Organization Patterns

**Folder-Based Components**:
When a component file grows large (>500 lines), refactor into folder structure:
```
components/
└── feature-name/
    ├── index.tsx          # Main component (exports default)
    ├── sub-component-1.tsx
    ├── sub-component-2.tsx
    └── utils.ts           # Shared helpers
```

**Benefits**:
- Each component in its own file (single responsibility)
- Shared utilities colocated with components
- Import paths unchanged: `@/components/feature-name` resolves to `index.tsx`

**Example**: `playground/` folder contains main component + 3 list components + utilities

**File Naming**:
- Use kebab-case for all files: `tool-executor.tsx`, `use-server-capabilities.ts`
- Index files: `index.tsx` (not `Feature.tsx`)
- Utilities: `utils.ts` (shared), feature-specific names for others

### UX & Navigation Patterns

**History Management**:
- Use `router.push()` for normal navigation (adds to history)
- Use `router.replace()` for destructive operations (replaces history entry)
- Example: After deleting a server, use `replace('/')` so back button doesn't return to deleted page

**Loading States**:
- Always show loading indicators on async operations
- Disable buttons during mutations: `disabled={mutation.isPending}`
- Show text changes: `{isPending ? "Deleting..." : "Delete"}`

**Optimistic Updates**:
- Not currently implemented, but consider for better UX
- Use React Query's `onMutate` for immediate feedback

**Empty States**:
- Provide helpful messages when no data
- Distinguish between: no data, loading, and errors
- Method not found = show "No X available" (not error)

### Authentication Flow

**Better Auth Configuration** (`src/lib/auth.ts`):
- Uses Drizzle adapter with PostgreSQL
- Session cookie cache enabled (5 min max age)
- Three auth methods:
  1. **GitHub OAuth** - Social login
  2. **Magic Link** - Passwordless email authentication
  3. **Anonymous** - Guest sessions

**Client Integration** (`src/lib/auth-client.ts`):
- React hooks via `better-auth/react`
- Magic link plugin enabled for client-side flows

**API Route**: `src/app/api/auth/[...all]/route.ts` handles all auth endpoints

### Environment Variables

Managed by T3 Env (`src/env.ts`) with Zod validation:
- `DATABASE_URL` - PostgreSQL connection string
- `GITHUB_CLIENT_ID` - GitHub OAuth app ID
- `GITHUB_CLIENT_SECRET` - GitHub OAuth secret
- `RESEND_API_KEY` - Resend email service key

Set `SKIP_ENV_VALIDATION=true` to bypass validation (useful for codegen).

### MCP Integration

This app integrates with the Model Context Protocol SDK (`@modelcontextprotocol/sdk`). The `server` table stores OAuth credentials and tokens for connecting to MCP servers, while the `log` table tracks all MCP JSON-RPC requests/responses.

**OAuth Scope Discovery**:
- We follow the MCP Authorization specification by letting servers define their own required scopes
- The MCP SDK automatically discovers scopes from the server's WWW-Authenticate header or Protected Resource Metadata
- No hardcoded scopes - this allows compatibility with different MCP servers:
  - Supabase uses specific scopes: `projects:read`, `database:read`, etc.
  - Other servers may use `mcp:*` or define no scopes at all
- Implementation: `src/lib/mcp/oauth-provider.ts` intentionally omits the `scope` parameter from `clientMetadata`

**OAuth State Management & Re-authorization**:
- OAuth temporary data (verifier, state, authUrl) expires after 30 minutes (`OAUTH_EXPIRATION_MS` in `credential-storage.ts`)
- Stale OAuth state is automatically cleared before each authorization attempt to prevent "Invalid or expired OAuth authorization" errors
- When tokens expire or become invalid:
  1. Query endpoints (listTools, listResources, listPrompts) detect 401 errors
  2. Automatically clear old OAuth temporary data
  3. Trigger fresh OAuth flow by attempting new connection
  4. Return new authUrl to client for user authorization
- Implementation: `src/server/api/routers/server.ts` (lines 254-269, 340-355, 426-441)

### Docker Database

PostgreSQL 17 container configured in `docker-compose.db.yml`:
- Container: `mcp-playground-db`
- Port: 5432
- Default credentials: `postgres`/`postgres`
- Database: `mcp-playground`
- Persistent volume: `postgres-data`

## Development Workflow

1. **First-time setup**:
   ```bash
   pnpm install
   pnpm docker:db:up
   pnpm db:push  # or db:migrate
   ```

2. **Daily development**:
   ```bash
   pnpm dev:all  # Starts DB + dev server
   ```

3. **Schema changes**:
   - Modify `src/db/schema/app.ts` (never edit `auth.ts` directly)
   - Run `pnpm db:generate` to create migration
   - Run `pnpm db:migrate` to apply migration
   - Or use `pnpm db:push` for rapid prototyping (skips migrations)

4. **Better Auth schema updates**:
   - Run `pnpm auth:generate` after updating auth config
   - This regenerates `src/db/schema/auth.ts`

## Important Notes

- **tRPC**: Fully integrated with React Query for type-safe API calls. Use tRPC for all server communication.
- **React 19 + Compiler**: This project uses React 19 with the React Compiler (babel plugin).
- **Ultracite Rules**: Strict linting rules are enforced via `.cursor/rules/ultracite.mdc`. Follow these patterns.
- **No `console` statements**: Ultracite disallows `console` - use proper logging if needed.
- **Type safety**: Always use `T[]` vs `Array<T>`, `export type` for types, no `any` types.
- **Database adapter**: Better Auth requires Drizzle schema regeneration if auth config changes significantly.
- **Parallel Queries**: Remove dependencies between queries for parallel execution where possible.
- **Cache Invalidation**: Use `queryClient.invalidateQueries()` (no params) for destructive operations.
- **Error Cause Field**: Always use `cause` field in TRPCError, not JSON.stringify in message.
- **Method Not Found**: JSON-RPC -32601 means no capability, not an error - show empty state.
